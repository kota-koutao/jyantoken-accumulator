<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>積み立て雀トークン</title>
    <meta name="theme-color" content="#ff6b6b">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* パスワード認証画面のスタイル */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--background-color);
        }

        .card {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }

        .auth-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .auth-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                transparent 0%,
                rgba(255, 255, 255, 0.05) 50%,
                transparent 100%);
            pointer-events: none;
        }

        .auth-box:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .auth-box h2 {
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .auth-input {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            color: var(--text-color);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .auth-input:focus {
            border-color: var(--accent-color);
            background-color: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
        }

        .auth-error {
            color: var(--error-color);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .auth-container.hidden {
            display: none;
        }

        /* 既存のスタイルを保持 */
        :root {
            --primary-color: #ffffff;
            --accent-color: #2ecc71;
            --text-color: #2c3e50;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --gradient-start: #ffffff;
            --gradient-end: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--text-color);
            line-height: 1.6;
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-color);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: -1px;
        }

        .description {
            text-align: center;
            color: #666;
            margin-bottom: 3rem;
        }

        .input-form {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 1.2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--text-color);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
            outline: none;
        }

        .form-group input:focus {
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .form-group input:focus + label {
            top: -1rem;
            left: 1rem;
            font-size: 0.8rem;
            color: var(--accent-color);
        }

        .input-form:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        input[type="date"],
        input[type="number"] {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            color: var(--text-color);
            font-size: 1.1rem;
            margin-bottom: 1.2rem;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        input[type="date"]:focus,
        input[type="number"]:focus {
            border-color: var(--accent-color);
            background-color: white;
            outline: none;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 1.2rem 2.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        table {
            width: 100%;
            border-collapse: separate;
            margin-bottom: 2rem;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        th {
            background: var(--accent-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        tr:hover td {
            background: #f8f9fa;
        }

        tr:hover {
            background-color: #2c3e50;
        }

        .delete-btn {
            background-color: var(--error-color);
            border: 2px solid transparent;
        }

        .delete-btn:hover {
            background-color: var(--error-color);
            border-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .summary {
            background-color: var(--primary-color);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        /* 同期関連のスタイル */
        .sync-status {
            margin: 2rem 0;
            padding: 1rem;
            background-color: var(--primary-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .icloud-status {
            margin: 1rem 0;
            padding: 1rem;
            background-color: var(--primary-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .sync-status span,
        .icloud-status span {
            color: var(--accent-color);
            font-weight: 500;
        }

        .sync-status button,
        .icloud-status button {
            margin: 0.5rem 0.5rem 0 0;
        }

        .summary h2 {
            margin-bottom: 1.5rem;
            color: var(--accent-color);
            font-size: 1.5rem;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 0.5rem;
        }

        .summary-item {
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .container {
                padding: 0;
            }

            .input-form {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .form-group {
                margin-bottom: 1rem;
            }

            input[type="date"],
            input[type="number"] {
                font-size: 1.2rem;
                padding: 0.8rem;
                margin-bottom: 1rem;
            }

            label {
                font-size: 1.1rem;
                margin-bottom: 0.8rem;
            }

            button {
                padding: 0.8rem 1.5rem;
                font-size: 1.2rem;
            }

            table {
                margin-bottom: 1.5rem;
            }

            th, td {
                padding: 0.8rem;
            }

            .summary {
                padding: 1.5rem;
            }

            .summary h2 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            .summary-item {
                font-size: 1rem;
                padding: 0.5rem 0;
            }

            /* スマートフォン用のテーブルレイアウト */
            @media (max-width: 480px) {
                table {
                    display: block;
                    overflow-x: auto;
                }

                table thead {
                    display: none;
                }

                table tr {
                    margin-bottom: 1rem;
                    border-bottom: 2px solid var(--border-color);
                }

                table td {
                    display: block;
                    text-align: right;
                    padding: 0.8rem 0;
                    border: none;
                }

                table td:before {
                    content: attr(data-label);
                    float: left;
                    font-weight: 600;
                    color: var(--accent-color);
                    margin-right: 1rem;
                }

                .delete-btn {
                    width: 100%;
                    margin-top: 0.5rem;
                }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>積み立て雀トークン</h1>
        <div class="description">
            <p>あなたの積立データを安全に管理</p>
        </div>

        <div class="input-form">
            <form id="depositForm">
                <div class="form-group">
                    <label for="date">日付</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label for="tokens">積立トークン数</label>
                    <input type="number" id="tokens" step="0.00001" required>
                </div>
                <div class="form-group">
                    <label for="investment">積立金額（JPY）</label>
                    <input type="number" id="investment" step="0.01" required>
                </div>
                <div class="button-group">
                    <button id="registerButton" class="settings-button" type="button" onclick="depositManager.registerDeposit()">登録</button>
                    <button id="updateButton" type="button" onclick="depositManager.updateDeposit()" style="display: none;">更新</button>
                    <button id="cancelButton" type="button" onclick="depositManager.cancelEdit()" style="display: none;">キャンセル</button>
                </div>
            </form>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>積立履歴</h2>
                <button class="settings-button" onclick="depositManager.openSettings()">設定</button>
            </div>
            <div class="summary-item">
                <span>総積立トークン数:</span>
                <span id="totalTokens">0</span>
            </div>
            <div class="summary-item">
                <span>総投資額（JPY）:</span>
                <span id="totalInvestment">0</span>
            </div>
            <div class="summary-item">
                <span>平均取得単価（JPY）:</span>
                <span id="averagePrice">0</span>
            </div>
        </div>

        <h2>月別サマリー</h2>
        <table id="monthlySummary">
            <thead>
                <tr>
                    <th>年月</th>
                    <th>合計トークン数</th>
                    <th>合計投資額（JPY）</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>積立履歴</h2>
        <table id="depositHistory">
            <thead>
                <tr>
                    <th>日付</th>
                    <th>積立トークン数</th>
                    <th>積立金額（JPY）</th>
                    <th>投資額（JPY）</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // iCloud同期用のクラス
        class iCloudSyncManager {
            constructor() {
                this.syncInterval = 300000; // 5分ごとに同期
                this.lastSyncTime = localStorage.getItem('last_sync_time');
                this.fileName = 'mahjong-deposit-data.json';
                this.deposits = [];
            }

            async init() {
                try {
                    // iCloud Driveのファイルシステムにアクセス
                    const iCloudFS = await this.getiCloudFileSystem();
                    await this.checkOrCreateFile(iCloudFS);
                    this.startAutoSync();
                    return true;
                } catch (error) {
                    console.error('iCloud初期化エラー:', error);
                    return false;
                }
            }

            async getiCloudFileSystem() {
                try {
                    // iCloud Driveのファイルシステムにアクセス
                    return await window.showDirectoryPicker({
                        types: ['json'],
                        excludeAcceptAllOption: true
                    });
                } catch (error) {
                    throw new Error('iCloudアクセスに失敗しました');
                }
            }

            async checkOrCreateFile(iCloudFS) {
                try {
                    // ファイルが存在しない場合は作成
                    const fileHandle = await iCloudFS.getFileHandle(this.fileName, { create: true });
                    if (!fileHandle) {
                        throw new Error('ファイル作成に失敗しました');
                    }
                    return fileHandle;
                } catch (error) {
                    throw new Error('ファイル作成に失敗しました');
                }
            }

            async syncData() {
                try {
                    // データを暗号化
                    const encryptedData = this.encryptData();
                    
                    // iCloud Driveに保存
                    await this.saveToiCloud(encryptedData);
                    
                    this.lastSyncTime = new Date().toISOString();
                    localStorage.setItem('last_sync_time', this.lastSyncTime);
                    return true;
                } catch (error) {
                    console.error('同期エラー:', error);
                    return false;
                }
            }

            async saveToiCloud(data) {
                try {
                    // iCloud Driveのファイルに保存
                    const iCloudFS = await this.getiCloudFileSystem();
                    const fileHandle = await iCloudFS.getFileHandle(this.fileName);
                    const writable = await fileHandle.createWritable();
                    await writable.write(data);
                    await writable.close();
                } catch (error) {
                    throw new Error('iCloud保存に失敗しました');
                }
            }

            encryptData() {
                // データを暗号化
                const deposits = JSON.stringify(this.deposits);
                return CryptoJS.AES.encrypt(deposits, this.getPassword()).toString();
            }

            decryptData(encryptedData) {
                // データを復号化
                const bytes = CryptoJS.AES.decrypt(encryptedData, this.getPassword());
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            }

            getPassword() {
                // パスワードをハッシュ化して使用
                return CryptoJS.SHA256(localStorage.getItem('app_password')).toString();
            }

            startAutoSync() {
                // 最終同期日を取得
                const lastSyncDate = localStorage.getItem('last_sync_date');
                const currentDate = new Date().toISOString().split('T')[0];

                // 今日が最終同期日と異なる場合のみ同期
                if (lastSyncDate !== currentDate) {
                    this.syncData().then(success => {
                        if (success) {
                            localStorage.setItem('last_sync_date', currentDate);
                            document.getElementById('lastSyncTime').textContent = `最後の同期: ${new Date().toLocaleString()}`;
                        }
                    });
                }

                // 次の日の同期を設定
                const nextSyncDate = new Date();
                nextSyncDate.setDate(nextSyncDate.getDate() + 1);
                nextSyncDate.setHours(0, 0, 0, 0);

                const now = new Date();
                const timeUntilNextSync = nextSyncDate - now;

                setTimeout(() => {
                    this.startAutoSync();
                }, timeUntilNextSync);
            }

            async manualSync() {
                const success = await this.syncData();
                if (success) {
                    alert('同期が完了しました');
                } else {
                    alert('同期に失敗しました');
                }
            }

            downloadBackup() {
                try {
                    // データを暗号化してダウンロード
                    const encryptedData = this.encryptData();
                    const blob = new Blob([encryptedData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'mahjong-deposit-backup.json';
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    alert('バックアップの作成に失敗しました');
                }
            }

            async connectiCloud() {
                try {
                    const success = await this.init();
                    if (success) {
                        document.getElementById('icloudStatus').textContent = 'iCloud接続: 接続済み';
                        alert('iCloudに接続しました');
                    } else {
                        document.getElementById('icloudStatus').textContent = 'iCloud接続: 未接続';
                        alert('iCloudへの接続に失敗しました');
                    }
                } catch (error) {
                    console.error('iCloud接続エラー:', error);
                    document.getElementById('icloudStatus').textContent = 'iCloud接続: 未接続';
                    alert('iCloudへの接続に失敗しました');
                }
            }
        }

        // パスワード認証用のクラス
        class AuthManager {
            constructor() {
                this.password = localStorage.getItem('app_password');
                this.isAuth = false;
            }

            async init() {
                if (!this.password) {
                    // 初回起動時はパスワード設定画面を表示
                    this.showSetPassword();
                } else {
                    // 既存のパスワードがある場合は認証画面を表示
                    this.showAuthForm();
                }
            }

            showSetPassword() {
                const authContainer = document.createElement('div');
                authContainer.className = 'auth-container';
                authContainer.innerHTML = `
                    <div class="auth-box">
                        <h2>パスワード設定</h2>
                        <form class="auth-form" id="setPasswordForm">
                            <input type="password" class="auth-input" id="newPassword" placeholder="新しいパスワードを入力" required>
                            <input type="password" class="auth-input" id="confirmPassword" placeholder="確認のため再度入力" required>
                            <button type="submit" class="auth-btn">設定する</button>
                        </form>
                    </div>
                `;
                document.body.appendChild(authContainer);

                const form = document.getElementById('setPasswordForm');
                form.addEventListener('submit', (e) => this.handleSetPassword(e));
            }

            handleSetPassword(e) {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    alert('パスワードが一致しません');
                    return;
                }

                // パスワードを暗号化して保存
                localStorage.setItem('app_password', this.encryptPassword(newPassword));
                this.password = this.encryptPassword(newPassword);
                this.showAuthForm();
            }

            showAuthForm() {
                const authContainer = document.createElement('div');
                authContainer.className = 'auth-container';
                authContainer.innerHTML = `
                    <div class="auth-box">
                        <h2>パスワード認証</h2>
                        <form class="auth-form" id="authForm">
                            <input type="password" class="auth-input" id="authPassword" placeholder="パスワードを入力" required>
                            <button type="submit" class="auth-btn">認証する</button>
                        </form>
                        <button class="auth-btn" onclick="authManager.resetPassword()">パスワードを忘れた場合</button>
                    </div>
                `;
                document.body.appendChild(authContainer);

                const form = document.getElementById('authForm');
                form.addEventListener('submit', (e) => this.handleAuth(e));
            }

            handleAuth(e) {
                e.preventDefault();
                const password = document.getElementById('authPassword').value;

                if (this.encryptPassword(password) === this.password) {
                    this.isAuth = true;
                    this.showApp();
                } else {
                    alert('パスワードが間違っています');
                }
            }

            resetPassword() {
                if (confirm('パスワードをリセットしますか？これにより現在のデータは削除されます。')) {
                    localStorage.clear();
                    window.location.reload();
                }
            }

            encryptPassword(password) {
                // 簡易的なハッシュ関数
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    hash = ((hash << 5) - hash) + password.charCodeAt(i);
                    hash |= 0;
                }
                return hash.toString();
            }

            showApp() {
                const authContainer = document.querySelector('.auth-container');
                if (authContainer) {
                    authContainer.classList.add('hidden');
                }

                // アプリケーションのメインコンテンツを表示
                const appContainer = document.createElement('div');
                appContainer.className = 'container';
                appContainer.innerHTML = `
                    <h1>フィナンシェ麻雀トークン積立管理</h1>
                    <div class="input-form">
                        <form id="depositForm">
                            <div class="form-group">
                                <label for="date">日付</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group">
                                <label for="tokens">積立トークン数</label>
                                <input type="number" id="tokens" step="0.00001" required>
                            </div>
                            <div class="form-group">
                                <label for="investment">積立金額（JPY）</label>
                                <input type="number" id="investment" step="0.01" required>
                            </div>
                            <button type="submit">登録</button>
                        </form>
                    </div>
                    <div class="summary">
                        <h2>総合サマリー</h2>
                        <div class="summary-item">
                            <span>総積立トークン数:</span>
                            <span id="totalTokens">0</span>
                        </div>
                        <div class="summary-item">
                            <span>総投資額（JPY）:</span>
                            <span id="totalInvestment">0</span>
                        </div>
                        <div class="summary-item">
                            <span>平均取得単価（JPY）:</span>
                            <span id="averagePrice">0</span>
                        </div>
                    </div>
                    <h2>月別サマリー</h2>
                    <table id="monthlySummary">
                        <thead>
                            <tr>
                                <th>年月</th>
                                <th>合計トークン数</th>
                                <th>合計投資額（JPY）</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <h2>積立履歴</h2>
                    <table id="depositHistory">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>積立トークン数</th>
                                <th>積立金額（JPY）</th>
                                <th>投資額（JPY）</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                `;
                document.body.appendChild(appContainer);

                // デポジットマネージャーを初期化
                const depositManager = new DepositManager();
            }
        }

        // デポジットマネージャークラス
        class DepositManager {
            constructor() {
                this.deposits = JSON.parse(localStorage.getItem('deposits') || '[]');
                this.syncManager = new iCloudSyncManager();
                this.syncManager.deposits = this.deposits;
                this.initEventListeners();
                this.renderAll();
                this.initiCloud();
            }

            initiCloud() {
                this.syncManager.init().then(success => {
                    if (success) {
                        document.getElementById('icloudStatus').textContent = 'iCloud接続: 接続済み';
                    } else {
                        document.getElementById('icloudStatus').textContent = 'iCloud接続: 未接続';
                    }
                });
            }

            initEventListeners() {
                const form = document.getElementById('depositForm');
                form.addEventListener('submit', (e) => this.handleSubmit(e));
            }

            handleSubmit(e) {
                e.preventDefault();
                const date = document.getElementById('date').value;
                const tokens = parseFloat(document.getElementById('tokens').value);
                const investment = parseFloat(document.getElementById('investment').value);

                const deposit = {
                    date: date,
                    tokens: tokens,
                    price: price,
                    investment: investment
                };

                this.deposits.unshift(deposit);
                this.saveToLocalStorage();
                this.renderAll();
                form.reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
            }

            saveToLocalStorage() {
                localStorage.setItem('deposits', JSON.stringify(this.deposits));
            }

            renderAll() {
                this.renderHistory();
                this.renderMonthlySummary();
                this.renderTotalSummary();
            }

            renderHistory() {
                const tbody = document.getElementById('depositHistory').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                this.deposits.forEach((deposit, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td data-label="日付">${deposit.date}</td>
                        <td data-label="積立トークン数">${deposit.tokens.toFixed(2)}</td>
                        <td data-label="積立金額（JPY）">${deposit.investment.toFixed(2)}</td>
                        <td data-label="投資額（JPY）">${deposit.investment.toFixed(2)}</td>
                        <td data-label="操作">
                            <button class="delete-btn" onclick="depositManager.deleteDeposit(${index})">削除</button>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // 同期ステータス
                    const syncStatusDiv = document.createElement('div');
                    syncStatusDiv.className = 'sync-status';
                    syncStatusDiv.innerHTML = `
                        <span id="lastSyncTime">最後の同期: 未同期</span>
                        <button onclick="depositManager.syncManager.manualSync()">手動同期</button>
                        <button onclick="depositManager.syncManager.downloadBackup()">バックアップダウンロード</button>
                    `;
                    tbody.appendChild(syncStatusDiv);

                    // iCloudステータス
                    const icloudStatusDiv = document.createElement('div');
                    icloudStatusDiv.className = 'icloud-status';
                    icloudStatusDiv.innerHTML = `
                        <span id="icloudStatus">iCloud接続: 未接続</span>
                        <button onclick="depositManager.syncManager.connectiCloud()">iCloudに接続</button>
                    `;
                    tbody.appendChild(icloudStatusDiv);
                });
            }

            renderMonthlySummary() {
                const tbody = document.getElementById('monthlySummary').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                const monthlyData = this.getMonthlySummary();
                Object.entries(monthlyData).forEach(([month, data]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td data-label="年月">${month}</td>
                        <td data-label="合計トークン数">${data.totalTokens.toFixed(2)}</td>
                        <td data-label="合計投資額（JPY）">${data.totalInvestment.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            renderTotalSummary() {
                const totalTokens = this.deposits.reduce((acc, curr) => acc + curr.tokens, 0);
                const totalInvestment = this.deposits.reduce((acc, curr) => acc + curr.investment, 0);
                const averagePrice = totalTokens > 0 ? (totalInvestment / totalTokens).toFixed(2) : '0';

                document.getElementById('totalTokens').textContent = totalTokens.toFixed(2);
                document.getElementById('totalInvestment').textContent = totalInvestment.toFixed(2);
                document.getElementById('averagePrice').textContent = averagePrice;
            }

            getMonthlySummary() {
                const summary = {};
                this.deposits.forEach(deposit => {
                    const date = new Date(deposit.date);
                    const month = this.getMonthName(date.getMonth() + 1);
                    
                    if (!summary[month]) {
                        summary[month] = {
                            totalTokens: 0,
                            totalInvestment: 0
                        };
                    }

                    summary[month].totalTokens += deposit.tokens;
                    summary[month].totalInvestment += deposit.investment;
                });

                return summary;
            }

            getMonthName(monthNumber) {
                const months = [
                    '1月', '2月', '3月', '4月', '5月', '6月',
                    '7月', '8月', '9月', '10月', '11月', '12月'
                ];
                return months[monthNumber - 1];
            }

            deleteDeposit(index) {
                if (confirm('この記録を削除しますか？')) {
                    this.deposits.splice(index, 1);
                    this.saveToLocalStorage();
                    this.renderAll();
                }
            }

            async deleteAllData() {
                // 1段階目: 初期確認
                if (!confirm('すべてのデータを削除しますか？この操作は取り消せません。')) {
                    return;
                }

                // 2段階目: パスワード認証
                const password = prompt('データを削除するにはパスワードを入力してください：');
                if (!password) {
                    return;
                }

                // パスワード認証の確認
                const authManager = new AuthManager();
                if (!authManager.encryptPassword(password) === authManager.password) {
                    alert('パスワードが間違っています');
                    return;
                }

                // 3段階目: 最終確認
                if (!confirm('本当にすべてのデータを削除しますか？')) {
                    return;
                }

                // バックアップを作成
                try {
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        deposits: this.deposits
                    };
                    const backupBlob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
                    const backupUrl = URL.createObjectURL(backupBlob);
                    const a = document.createElement('a');
                    a.href = backupUrl;
                    a.download = `mahjong-deposits-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(backupUrl);
                    alert('バックアップが作成されました');
                } catch (error) {
                    console.error('バックアップ作成エラー:', error);
                }

                // データを削除
                this.deposits = [];
                localStorage.removeItem('deposits');
                this.updateUI();
                await this.icloudSync.syncData();

                // 削除完了の通知
                alert('データが削除されました。');
            }
        }

        // メインのインスタンスを作成
        const authManager = new AuthManager();
        authManager.init();

        // ページ読み込み時に今日の日付を設定
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('date');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
        });
    </script>
</body>
</html>
